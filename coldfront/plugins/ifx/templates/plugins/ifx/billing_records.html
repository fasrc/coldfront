{% extends "common/base.html" %}
{% load common_tags %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}
Billing Records
{% endblock %}


{% block content %}
<style>
    .dataTables_filter {
        display: inline-flex;
        margin: 0 0.5em 0 0;
    }
    .dataTables_length {
        display: inline-flex;
        margin: 0 0.5em 0 0;
        float: right;
    }
    #notification-errors {
        font-size: 10pt;
        color: red;
    }
    .result-header {
        font-size: 12pt;
        font-weight: bold;
        margin: 1em 0 0.5em 0;
    }
    label {
        margin: 0 0 0 1em;
    }
</style>
<script>
    (function($){
        $(document).ready(function(){

            $( "#progressbar" ).progressbar({
                value: false
            });
            var dialog = $('#loading').dialog(
                {
                    autoOpen: false,
                    height: 200,
                    width: 300,
                    modal: true,
                    title: 'Working...'
                }
            )
            var notificationDialog = $('#notification').dialog(
                {
                    autoOpen: false,
                    height: 300,
                    width: 500,
                    modal: true,
                    title: 'Notify Lab Managers',
                }
            )
            $(document)
                .ajaxStart(function () {
                    dialog.dialog("open");
                })
                .ajaxStop(function () {
                    dialog.dialog("close");
                });

            $("#billing-record-reload").click((ev) => {
                ev.preventDefault()
                if (!$("#year").val() || !$("#month").val()) {
                    alert("Year and Month are required")
                    return
                } else {
                    billingRecordsTable.ajax.reload()
                }
            })
            $("#start-notification").click((ev) => {
                ev.preventDefault()
                notificationDialog.dialog("open")
            })
            $("#send-notification").click((ev) => {
                ev.preventDefault()
                $("#notification-errors").html("")
                $("#notification-successes").html("")
                const year = $("#year").val()
                const month = $("#month").val()
                if (!year || !month) {
                    alert("Year and Month are required")
                } else {
                    $.ajax({
                        contentType: 'application/json',
                        url: `/ifx/api/send-billing-record-review-notification/${year}/${month}/`,
                        method: 'POST',
                        headers: {'X-CSRFToken': '{{ csrf_token }}'},
                        data: "{}",
                        success: (data) => {
                            // Use jquery to compose a table of errors and successes
                            if (data.errors) {
                                var errorBlock = $("<div></div>")
                                errorBlock.append('<div class="result-header">Errors</div>')
                                var table = $("<table></table>")
                                $.each(data.errors, (i, item) => {
                                    Object.keys(item).forEach((key) => {
                                        table.append(`<tr><td>${item[key]}</td></tr>`)
                                    })
                                })
                                errorBlock.append(table)
                                $("#notification-errors").html(errorBlock)
                            }
                            if (data.successes) {
                                var successBlock = $("<div></div>")
                                successBlock.append('<div class="result-header">Successes</div>')
                                var table = $("<table></table>")
                                const count = data.successes.length
                                table.append(`<tr><td>${count} organizations successfully notified.</td></tr>`)
                                successBlock.append(table)
                                $("#notification-successes").html(successBlock)
                            }
                        }
                    })
                }
            })

            var billingRecordsTable = $("#billing-records").DataTable({
                dom: '<fl>tp',
                columns: [
                    {data: function(item){ return item.current_state.replace(/_/g, ' ')}, width: '200px'},
                    {data: 'product_usage.product_user.full_name', width: '100px'},
                    {data: function(item){ return item.account.organization.replace(/ \(a Harvard.*/, '')}, width: '300px'},
                    {data: function(item){ return `<span style="white-space: nowrap;">${item.account.code}</span><br/>(${item.account.name})`}, width: '400px'},
                    {data: function(item){ return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD',}).format(item.decimal_charge)}, width: '100px'},
                    {data: 'percent', width: '50px'},
                    {data: 'description', width: '500px'},
                ],
                order: [[ 2, "asc" ], [ 1, "asc" ]],
                ajax: {
                    url: '/ifx/api/billing/get-billing-record-list/',
                    type: 'GET',
                    data: function (d)  {
                        d.year = $("#year").val()
                        d.month = $("#month").val()
                        d.invoice_prefix = 'RC'
                    },
                    dataSrc: '',
                },
                {% comment %}
                footerCallback: function (row, data, start, end, display) {
                    // THIS DOES NOT WORK because the ajax call is not done yet
                    // Leaving it here, because I'd like to find a fix
                    let api = this.api();

                    // Remove the formatting to get integer data for summation
                    let intVal = function (i) {
                        return typeof i === 'string'
                            ? i.replace(/[\$,]/g, '') * 1
                            : typeof i === 'number'
                            ? i
                            : 0;
                    };

                    // Total over all pages
                    total = api
                        .column(4)
                        .data()
                        .reduce((a, b) => intVal(a) + intVal(b), 0);

                    // Total over this page
                    pageTotal = api
                        .column(4, { page: 'current' })
                        .data()
                        .reduce((a, b) => intVal(a) + intVal(b), 0);

                    // Update footer

                    if (api.column(4).footer()) {
                        api.column(4).footer().innerHTML =
                            '$' + pageTotal + ' ( $' + total + ' total)';
                    }
                } {% endcomment %}
            })

        })
    })(jQuery)

</script>
<div style="font-size: 10pt;">
    <div id="loading">
        <p>
            <div id="progressbar"></div>
        </p>
    </div>
    <div id="notification" style="display: none;">
        <div style="position: relative; float: left;">
            Send notification to lab managers
        </div>
        <div style="position: relative; float: right;">
            <input type="submit" id="send-notification" value="Go"/>
        </div>
        <div style="clear: both;"></div>
        <div id="notification-errors"></div>
        <div id="notification-successes"></div>
    </div>
    <div style="margin: 1em; width: 100%;">
        <div style="position: relative; float: left;">
            <label for="year">Year</label>
            <input type="text" id="year" name="year" value="2024"/>
            <label for="month">Month</label>
            <input type="text" id="month" name="month" value="5"/>
        </div>
        <div style="position: relative; float: left; margin-left: 1em;">
            <input id="billing-record-reload" type="submit" value="Reload Data"></input>
        </div>
        <div style="position: relative; float: right; margin-left: 1em;">
            <input id="start-notification" type="submit" value="Notify Lab Managers"></input>
        </div>
        <div style="clear: both;"></div>
    </div>
    <hr/>
    <div style="margin: 1em;">
        <table id="billing-records" class="display" style="width: 100%" cellpadding="5px">
            <thead>
                <tr>
                    <th>State</th>
                    <th>User</th>
                    <th>Lab</th>
                    <th>Expense Code / PO</th>
                    <th>Charge</th>
                    <th>Percent</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>

{% endblock %}
