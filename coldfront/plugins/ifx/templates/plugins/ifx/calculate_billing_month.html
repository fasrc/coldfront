{% extends "common/base.html" %}
{% load common_tags %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}
Calculate Billing Month
{% endblock %}


{% block content %}
<script>
    (function($){
        $(document).ready(function(){

            $( "#progressbar" ).progressbar({
                value: false
            });
            var dialog = $('#loading').dialog(
                {
                    autoOpen: false,
                    height: 200,
                    width: 300,
                    modal: true,
                }
            )
            $(document)
            .ajaxStart(function () {
                dialog.dialog("open");
            })
            .ajaxStop(function () {
                dialog.dialog("close");
            });

            var productUsagesTable = $("#product-usages").DataTable({
                dom: '<lf>tp',
                columns: [
                    {data: 'id', width: '100px'},
                    {data: 'full_name', width: '100px'},
                    {data: 'year', width: '100px'},
                    {data: 'month', width: '100px'},
                    {data: 'organization', width: '100px'},
                    {data: 'product_name', width: '100px'},
                    {data: 'description', width: '500px'},
                    {data: 'error_message', width: '100px'},
                ],
                ajax: {
                    url: '/ifx/api/get-product-usages/',
                    type: 'GET',
                    data: {
                        year: 2024,
                        month: 5
                    },
                    dataSrc: '',
                }
            })

            $("input[type='submit']").click((ev) => {
                ev.preventDefault()

                // Get the year and month from the picker
                const year = 2024
                const month = 5
                const recalculate = true

                $.ajax({
                    contentType: 'application/json',
                    url: `/ifx/api/calculate-billing-month/${year}/${month}/`,
                    method: 'POST',
                    headers: {'X-CSRFToken': '{{ csrf_token }}'},
                    data: JSON.stringify({
                        'recalculate': recalculate
                    }),
                    dataType: "json"
                }).done(
                    function () { productUsagesTable.ajax.reload() }
                )
            })
        })
    })(jQuery)

</script>
<div>
    <div id="loading">
        <p>
            <div id="progressbar"></div>
        </p>
    </div>
    <div style="margin: 1em;">
        <form method="post">
            {% csrf_token %}
            <input type="submit" value="Calculate Billing Month"></input>
        </form>
    </div>
    <div style="margin: 1em;">
        <table id="product-usages" class="display" style="width: 100%" cellpadding="5px">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>User</th>
                    <th>Year</th>
                    <th>Month</th>
                    <th>Organization</th>
                    <th>Product</th>
                    <th>Description</th>
                    <th>Processing</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>

{% endblock %}
